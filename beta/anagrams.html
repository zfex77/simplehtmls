<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anagram77</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
    }
    .letters {
      font-size: 2.5rem;
      font-weight: bold;
      letter-spacing: 15px;
      margin: 20px 0;
      user-select: none;
    }
    .word {
      display: inline-block;
      margin: 5px 8px;
      padding: 6px 12px;
      background: #1f1f1f;
      border-radius: 6px;
      font-weight: bold;
      transition: background-color 1s ease;
      user-select: none;
    }
    .word.found {
      background-color: #1f5e1f !important;
      color: #b6ffb6;
      box-shadow: 0 0 12px 3px #90ee9099;
      transition: background-color 1.5s ease;
    }
    .word.streak {
      background-color: #a67c00 !important;
      color: #fff176;
      box-shadow: 0 0 15px 5px #ffd700cc;
      transition: background-color 1.5s ease;
    }
    .word.invalid {
      background-color: #8b0000 !important;
      color: #ffb6b6;
      box-shadow: 0 0 12px 3px #ff666699;
      transition: background-color 1.5s ease;
    }
    .form-control {
      background-color: #1f1f1f;
      color: #ffffff;
      border: 1px solid #333;
    }
    .form-control:focus {
      background-color: #1f1f1f;
      color: #ffffff;
      border: 1px solid #555;
      outline: none;
      box-shadow: 0 0 8px #33bb33aa;
    }
    .btn {
      margin: 5px;
    }
    #result {
      height: 1.5em;
      margin-top: 10px;
      font-weight: bold;
      min-height: 1.5rem;
    }
    #timer {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 10px;
      user-select: none;
    }
    #possibleWords {
      max-height: 250px;
      overflow-y: auto;
      margin-top: 15px;
      border-top: 1px solid #333;
      padding-top: 10px;
      font-size: 0.9rem;
      user-select: none;
    }
    #possibleWords .word {
      cursor: default;
      background-color: #2a2a2a;
      margin: 3px 6px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    #possibleWords .score {
      margin-left: 8px;
      color: #66ff66;
      font-weight: bold;
    }    
    #score {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 10px;
      color: gold;
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #121212;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 1.5rem;
    }
    #invalidWords {
      margin-top: 15px;
      border-top: 1px solid #333;
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">Loading dictionary...</div>

  <div class="container text-center py-5" style="display: none;" id="mainContent">
    <h1 class="mb-4">Anagrams v1.1</h1>
    <div class="letters" id="lettersDisplay">???????</div>

    <div class="mb-3">
      <input type="text" id="wordInput" class="form-control d-inline-block w-50" placeholder="Enter word..." disabled />
    </div>

    <div>
      <button class="btn btn-primary" id="submitBtn" onclick="submitWord()" disabled>Submit</button>
      <button class="btn btn-secondary" id="revealBtn" onclick="revealAnagram()">Reveal Anagram</button>
      <button class="btn btn-danger" id="giveUpBtn" onclick="giveUp()">Give Up</button>
      <button class="btn btn-success" id="shareBtn" onclick="shareAnagram()" style="display:none;">Share Anagram</button>
      <button class="btn btn-info" id="customBtn" onclick="showCustomAnagram()">Custom Anagram</button>
      <button class="btn btn-warning" id="newGameBtn" onclick="startNewGame()">New Game</button>
    </div>

    <!-- Custom Anagram Modal -->
    <div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000;">
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#1f1f1f; padding:30px; border-radius:10px; min-width:350px;">
        <h4 style="color:white; margin-bottom:20px;">Create Custom Anagram</h4>
        <input type="text" id="customWordInput" placeholder="Enter any letters..." style="width:100%; padding:10px; margin-bottom:15px; background:#2a2a2a; color:white; border:1px solid #555; border-radius:5px;" maxlength="15">
        
        <div style="text-align:center;">
          <button class="btn btn-success" onclick="createCustomAnagram()">Create</button>
          <button class="btn btn-secondary" onclick="hideCustomAnagram()">Cancel</button>
        </div>
        <div id="customError" style="color:#ff6b6b; margin-top:10px; text-align:center;"></div>
      </div>
    </div>

    <div id="result"></div>
    <div id="score" class="mt-2">Score: 0</div>
    <div id="timer">1:30</div>

    <div id="possibleWords" class="mt-4"></div>
    <div id="invalidWords"></div>
  </div>

<script>
  let dictionary = new Set();
  let sevenLetterWords = [];
  let baseLetters = "";
  let found = [];
  let score = 0;
  let timeLeft = 90;
  let timerInterval = null;
  let anagramRevealed = false;
  let possibleWords = [];
  let giveUpActive = false;
  let isCustomGame = false;

  // Streak variables
  let streakCount = 0;

  // Always use the fixed dictionary URL here:
  const DICTIONARY_URL = 'https://cdn.jsdelivr.net/gh/dwyl/english-words/words_alpha.txt';

  async function loadDictionary() {
    try {
      const response = await fetch(DICTIONARY_URL);
      const text = await response.text();
      const words = text.split("\n").map(w => w.trim().toLowerCase());
      dictionary = new Set(words);
      sevenLetterWords = words.filter(w => w.length === 7 && /[aeiou].*[aeiou]/.test(w));
    } catch(e) {
      alert("Failed to load dictionary.");
      console.error(e);
    }
    document.getElementById("loadingScreen").style.display = "none";
    document.getElementById("mainContent").style.display = "block";

    // Check URL for shared shuffled anagram
    const params = new URLSearchParams(window.location.search);
    const shared = params.get('a');
    if (shared) {
      try {
        const decoded = atob(shared);
        if (decoded.length === 7 && /^[a-z]+$/.test(decoded)) {
          baseLetters = decoded.toLowerCase();
          setupSharedGame();
          return;
        }
      } catch {}
    }

    startNewGame();
  }

  // Shuffle string
  function shuffle(str) {
    let arr = str.split('');
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr.join('');
  }

  // Check if word can be made from letters
  function canMakeWord(word, letters) {
    let temp = letters.split('');
    for (let c of word) {
      const idx = temp.indexOf(c);
      if (idx === -1) return false;
      temp.splice(idx, 1);
    }
    return true;
  }

  // Calculate score based on word length
  function calculateScore(length) {
    switch(length) {
      case 2: return 50;
      case 3: return 100;
      case 4: return 400;
      case 5: return 1200;
      case 6: return 3000;
      case 7: return 5000;
      case 8: return 8000;
      case 9: return 12500;
      case 10: return 15000;
      case 11: return 20000;
      case 12: return 25000;
      case 13: return 50000;
      case 14: return 75000;
      case 15: return 100000;
      default: return length > 15 ? 100000 : 0;
    }
  }

  // Generate possible words sorted by descending score
  function generatePossibleWords() {
    const validWords = [];
    for (const w of dictionary) {
      if (w.length >= 2 && canMakeWord(w, baseLetters)) {
        validWords.push(w);
      }
    }
    validWords.sort((a,b) => calculateScore(b.length) - calculateScore(a.length) || b.localeCompare(a));
    return validWords;
  }

  // Start a new game: get a new word, shuffle it, show ???, disable input, enable share/reveal
  function startNewGame() {
    clearInterval(timerInterval);
    found = [];
    score = 0;
    timeLeft = 90;
    streakCount = 0;
    anagramRevealed = false;
    possibleWords = [];
    giveUpActive = false;
    isCustomGame = false;

    const word = sevenLetterWords[Math.floor(Math.random() * sevenLetterWords.length)];
    baseLetters = shuffle(word);
    resetUIForNewGame();
  }

  // Setup game for shared link - letters hidden, waiting for reveal
  function setupSharedGame() {
    clearInterval(timerInterval);
    found = [];
    score = 0;
    timeLeft = 90;
    streakCount = 0;
    anagramRevealed = false;
    possibleWords = [];
    giveUpActive = false;
    isCustomGame = false;

    resetUIForNewGame();
  }

  function resetUIForNewGame() {
    document.getElementById('lettersDisplay').textContent = '?'.repeat(baseLetters.length);
    document.getElementById('wordInput').value = '';
    document.getElementById('wordInput').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('revealBtn').style.display = 'inline-block';
    document.getElementById('giveUpBtn').style.display = 'none';
    document.getElementById('shareBtn').style.display = isCustomGame ? 'none' : 'inline-block';
    document.getElementById('customBtn').style.display = 'inline-block';
    document.getElementById('newGameBtn').disabled = false;
    document.getElementById('result').textContent = '';
    document.getElementById('score').textContent = 'Score: 0';
    document.getElementById('timer').textContent = formatTime(timeLeft);
    document.getElementById('possibleWords').innerHTML = '';
    const foundWords = document.getElementById('foundWords');
    if (foundWords) foundWords.remove();
  }

  // Reveal the anagram letters, enable input and start timer
  function revealAnagram() {
    if (anagramRevealed) return;
    anagramRevealed = true;

    document.getElementById('lettersDisplay').textContent = baseLetters.toUpperCase();
    document.getElementById('wordInput').disabled = false;
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('revealBtn').style.display = 'none';
    document.getElementById('giveUpBtn').style.display = 'inline-block';
    document.getElementById('shareBtn').style.display = 'none';
    document.getElementById('customBtn').style.display = 'none';
    document.getElementById('newGameBtn').disabled = false;

    possibleWords = generatePossibleWords();

    timerInterval = setInterval(() => {
      timeLeft--;
      document.getElementById('timer').textContent = formatTime(timeLeft);
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        endGame();
      }
    }, 1000);
  }

  // Give up: show all possible words without animation
  function giveUp() {
    if (giveUpActive || !anagramRevealed) return;
    
    giveUpActive = true;
    
    // Stop the timer
    clearInterval(timerInterval);
    document.getElementById('timer').textContent = formatTime(0);
    
    // Disable input
    document.getElementById('wordInput').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    
    // Show all possible words immediately
    showAllWords();
    
    document.getElementById('result').textContent = `You gave up! Here are all ${possibleWords.length} possible words.`;
    document.getElementById('newGameBtn').disabled = false;
    
    // Reset give up button for next use
    giveUpActive = false;
  }
  
  // Show all possible words (used by give up and end game)
  function showAllWords() {
    const pwDiv = document.getElementById('possibleWords');
    pwDiv.innerHTML = "<h5>Valid words:</h5>";

    possibleWords.sort((a,b) => calculateScore(b.length) - calculateScore(a.length) || a.localeCompare(b));

    for (const w of possibleWords) {
      const span = document.createElement('span');
      span.className = 'word';
      if (found.includes(w)) {
        span.style.backgroundColor = '#1f5e1f';
        span.style.color = '#b6ffb6';
      }
      span.textContent = w.toUpperCase();

      const scoreSpan = document.createElement('span');
      scoreSpan.className = 'score';
      scoreSpan.textContent = `+${calculateScore(w.length)}`;

      pwDiv.appendChild(span);
      pwDiv.appendChild(scoreSpan);
    }
  }

  // Format seconds to MM:SS
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
  }

  // Submit a word guess
  function submitWord() {
    const input = document.getElementById('wordInput');
    let word = input.value.trim().toLowerCase();

    if (!word) return;

    // Check if already found
    if (found.includes(word)) {
      setResult(`You already found "${word.toUpperCase()}"`);
      resetStreak();
      input.value = '';
      return;
    }

    if (word.length < 2) {
      setResult("Words must be at least 2 letters.");
      resetStreak();
      input.value = '';
      return;
    }

    // Check if can be made from letters first
    if (!canMakeWord(word, baseLetters)) {
      setResult(`"${word.toUpperCase()}" cannot be made from the anagram letters.`);
      resetStreak();
      input.value = '';
      return;
    }

    // Now check if it's a valid dictionary word
    if (!dictionary.has(word)) {
      setResult(`"${word.toUpperCase()}" cannot be made from the anagram letters.`);
      resetStreak();
      input.value = '';
      return;
    }

    // Valid word - award points
    found.push(word);

    streakCount++;
    
    let streakMultiplier = 1;
    if (streakCount >= 4) {
      streakMultiplier = Math.pow(1.10, streakCount - 3);
    }

    const baseWordScore = calculateScore(word.length);
    const wordScore = Math.floor(baseWordScore * streakMultiplier);
    score += wordScore;
    document.getElementById('score').textContent = `Score: ${score}`;

    addFoundWord(word, streakCount >= 4);

    if (streakCount >= 4) {
      setResult(`Streak x${streakCount}! +"${wordScore}" points!`);
    } else {
      setResult(`Good job! Found "${word.toUpperCase()}" +${wordScore} points`);
    }

    input.value = '';
  }

  // Reset streak counter on invalid/repeated word
  function resetStreak() {
    streakCount = 0;
  }

  // Add found word to list and show glow effect (green or gold)
  function addFoundWord(word, streaking) {
    const pwDiv = document.getElementById('possibleWords');

    // If no word list shown yet, create container and header
    if (pwDiv.innerHTML === '') {
      pwDiv.innerHTML = "<h5>Valid words found:</h5>";
    }

    const span = document.createElement('span');
    span.classList.add('word', 'found');
    span.textContent = word.toUpperCase();

    if (streaking) {
      span.classList.add('streak');
    }

    // Animate glow: add class and remove after 1.5s
    setTimeout(() => {
      span.style.transition = "box-shadow 1.5s ease, background-color 1.5s ease";
      span.classList.remove(streaking ? 'streak' : 'found');
    }, 1500);

    // Add score span
    const scoreSpan = document.createElement('span');
    scoreSpan.className = 'score';
    scoreSpan.textContent = `+${calculateScore(word.length)}`;

    pwDiv.appendChild(span);
    pwDiv.appendChild(scoreSpan);
  }

  // Add invalid word to list
  function addInvalidWord(word) {
    const iwDiv = document.getElementById('invalidWords');

    // If no invalid word list shown yet, create container and header
    if (iwDiv.innerHTML === '') {
      iwDiv.innerHTML = "<h5>Invalid words you tried:</h5>";
    }

    const span = document.createElement('span');
    span.classList.add('word', 'invalid');
    span.textContent = word.toUpperCase();

    // Animate glow: add class and remove after 1.5s
    setTimeout(() => {
      span.style.transition = "box-shadow 1.5s ease, background-color 1.5s ease";
      span.classList.remove('invalid');
    }, 1500);

    const noteSpan = document.createElement('span');
    noteSpan.className = 'invalid-word';
    noteSpan.textContent = " (not a word)";

    iwDiv.appendChild(span);
    iwDiv.appendChild(noteSpan);
  }

  // Display result text
  function setResult(text) {
    const res = document.getElementById('result');
    res.textContent = text;
  }

  // End game and show all possible words with scores sorted descending
  function endGame() {
    document.getElementById('wordInput').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('result').textContent = "Time's up!";
    showAllWords();
    document.getElementById('newGameBtn').disabled = false;
  }

  // Share the shuffled anagram letters (base64 encode) in URL
  function shareAnagram() {
    if (!baseLetters || isCustomGame) return;
    const encoded = btoa(baseLetters);
    const url = `${window.location.origin}${window.location.pathname}?a=${encoded}`;
    navigator.clipboard.writeText(url).then(() => {
      setResult("Share link copied to clipboard!");
    }, () => {
      alert("Failed to copy share link. Here's the link:\n" + url);
    });
  }

  // Show custom anagram modal
  function showCustomAnagram() {
    document.getElementById('customModal').style.display = 'block';
    document.getElementById('customWordInput').value = '';
    document.getElementById('customError').textContent = '';
    document.getElementById('customWordInput').focus();
  }

  // Hide custom anagram modal
  function hideCustomAnagram() {
    document.getElementById('customModal').style.display = 'none';
  }

  // Create custom anagram from user input
  function createCustomAnagram() {
    const input = document.getElementById('customWordInput').value.trim().toLowerCase();
    const errorDiv = document.getElementById('customError');
    
    if (input.length < 2) {
      errorDiv.textContent = 'Please enter at least 2 letters.';
      return;
    }
    
    if (!/^[a-z]+$/.test(input)) {
      errorDiv.textContent = 'Please use only letters A-Z.';
      return;
    }
    
    // Start custom game
    clearInterval(timerInterval);
    found = [];
    score = 0;
    timeLeft = 90;
    streakCount = 0;
    anagramRevealed = false;
    possibleWords = [];
    giveUpActive = false;
    isCustomGame = true;
    
    baseLetters = shuffle(input);
    resetUIForNewGame();
    hideCustomAnagram();
  }

  window.onload = () => {
    loadDictionary();

    document.getElementById('wordInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') submitWord();
    });

    document.getElementById('customWordInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') createCustomAnagram();
      if (e.key === 'Escape') hideCustomAnagram();
    });

    // Close modal when clicking outside
    document.getElementById('customModal').addEventListener('click', e => {
      if (e.target.id === 'customModal') hideCustomAnagram();
    });
  };
</script>
</body>
</html>
